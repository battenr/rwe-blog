{
  "hash": "5771cbb3032289a206c602079a616dee",
  "result": {
    "markdown": "---\nttitle: \"Inverse Probability Weighting\"\nauthor: \"Ryan Batten\"\ndate: \"2022-08-16\"\ncategories: [IPW, IPTW]\nimage: \"iptw.jpeg\"\nbibliography: ip_weighting.bib\ndraft: true\n---\n\n\n## Re-weighting? Like a scale?\n\nRe-weighting in this context has nothing to do with weight. Instead it is a statistical method that is used to adjust for effect modification and confounding to ensure exchangeability. This method can be helpful for answering questions about the ***marginal*** or ***conditional*** causal effect.\n\nNow, what is a better way to get started than with probability yet again. In this case, we are going to talk about the probability of receiving treatment.\n\n::: callout-note\nThis post will draw heavily from Chapter 12 of What If [@hernanwhatif]\n:::\n\n## Propensity Score\n\nA term that is commonly used in clinical epidemiology is the ***propensity score***. The propensity score is the conditional probability of receiving treatment [@hernanwhatif], or in mathematical notation:\n\n\n$$\nPr[A = 1| L = l]\n$$\n\n\nWhere A is treatment and L is covariates.\n\nImagine we have a clinical trial with two groups, wanting to determine if bouncing up and down on a trampoline causes a headache. The treatment group get to bounce on a trampoline for 10 minutes, while the control group have to sit down on a chair for 10 minutes. In this scenario, the propensity score would be the conditional probability of getting to bounce on the trampoline based on your age, sex and color shirt you are wearing.\n\n## Does jumping on a trampoline cause a headache?\n\nWhile theoretical discussions are helpful, numbers always help to really drive a point home. While we can't conduct a clinical trial, luckily there is a database that has already collected data on such a scenario.\n\n\n\n\n\n+------------------------------------+----------------+----------------+\n|                                    | Trampoline     | Chair          |\n|                                    |                |                |\n|                                    | (n = 260)      | (n = 469)      |\n+====================================+:==============:+:==============:+\n| Age, mean (SD)                     | 17.1 (4.6)     | 52.8 (19.4)    |\n+------------------------------------+----------------+----------------+\n| Female, n (%)                      | 194 (74.6)     | 135 (28.8)     |\n+------------------------------------+----------------+----------------+\n| T-Shirt Color, n (%)               | 124 (47.7)     | 60 (12.8)      |\n|                                    |                |                |\n| Pink                               | 84 (32.3)      | 184 (39.2)     |\n|                                    |                |                |\n| Orange                             | 37 (14.2)      | 134 (28.6)     |\n|                                    |                |                |\n| Blue                               | 15 (5.8)       | 91 (19.4)      |\n|                                    |                |                |\n| Yellow                             |                |                |\n+------------------------------------+----------------+----------------+\n| Brain Freeze, n (%)                | 92 (35.4)      | 220 (46.9)     |\n+------------------------------------+----------------+----------------+\n| Time Standing (minutes), mean (SD) | 31.4 (18.0)    | 29.8 (17.3)    |\n+------------------------------------+----------------+----------------+\n| Headache                           | 159 (61.2)     | 172 (36.7)     |\n+------------------------------------+----------------+----------------+\n\n: Trampoline Jumpers vs Chair Sitters {#tbl-demo}\n\nNow, if our causal question is \"Does jumping on a trampoline cause a headache?\" we need to look at the two groups that we are comparing. If we review @tbl-demo, do the two groups look similar? These two groups seem quite different. If these two are so different how can we expect to even compare the two?! That's like comparing apples to coconuts! Well, luckily we can use a statistical method known as inverse probability of treatment weighting to make those coconuts look more like apples. Think of it like we are painting the coconuts, and focusing more on the ones that are a similar size and shape.\n\n## Pseudo-Population\n\nThe goal of reweighing is to make a pseudo-population where exchangeability holds. Essentially, in our \"make believe\" sample the two groups would be comparable. One way to do this, is to fit a logistic regression (since the outcome would be a yes/no) to trampoline jumpers. Using this model, we can predict the probability of someone being a trampoline jumper, or conversely the probability that they are not a trampoline jumper. Once we do that, we can compare the two groups. First, we need to go over some basics of IP weighting.\n\n## IP Weighting\n\nThe pseudo-population is created by weighting each individual by the inverse of the conditional probability of receiving the treatment they did actually receive [@hernanwhatif, pp. 151].\n\n\n$$\nW^a = \\frac{1}{f[A|L]}\n$$\n\n\nFor our example, $f[A|L]$ is the probability of being a trampoline jumper conditional on the measured confounders (in mathematical notation:\n\n\n$$\nPr[A = \\text{trampoline jumpers} | \\text{L = age, sex, t-shirt color, time standing}]\n$$\n\n\nNow, from probability we know that the total probability has to equal 1. So:\n\n\n$$\nPr[A = \\text{not trampoline jumpers}|L] = 1 - Pr[A = \\text{trampoline jumpers} | L]\n$$\n\n\nGreat! So basically all we need to do is calculate the probability of being a trampoline jumper given measured confounders then we can calculate the conditional probability of not being a trampoline jumper . Now how do we calculate this conditional probability?\n\n### Logistic Regression\n\nSince our two groups can be thought of as a binary variable, trampoline jumpers or not trampoline jumpers, we get a parametric estimate using logistic regression of $Pr[A=\\text{trampoline jumper}|L]$. If no confounding for the effect of A in the pseudo-population and the model is correctly specified then association is causation and an unbiased estimator of the associational difference in the pseudo-population:\n\n\n$$\nE[Headache | A = \\text{trampoline jumper}] - E[Headache | A = \\text{not a trampoline jumper}]\n$$\n\n\nis also an unbiased estimator of the causal difference:\n\n\n$$\nE[Headache^{a = \\text{trampoline jumper}}] - E[Headache^{a = \\text{not a trampoline jumper}}]\n$$\n\n\n## Estimating Weights \n\nNow we are ready to estimate some weights! We will estimate the weights using a logistic regression with the following variables: age, sex, t-shirt color and time standing. Using that model we will calculate the weights.\\^\\[Note that the weights and probability are estimated/predicted\\]\n\n\n$$\n\\hat{W} = \\frac{1}{\\hat{Pr}[A = \\text{trampoline jumper} | L]}\n$$\n\n\nand for not trampoline jumpers as:\n\n\n$$\n\\hat{W} = \\frac{1}{1 - \\hat{Pr}[A = \\text{trampoline jumper} | L]}\n$$\n\n\n\\[\\^1\\]: Remember that $\\hat{W}$ and $\\hat{Pr}$ refer to the predicted values.\n\n### General Formula\n\nThe below formula is from [@hernanwhatif, pp.153].\n\n\n$$\nW^a = \\frac{p}{f[A|L]}\n$$\n\n\nwhere $p$ is the unconditional probability of treatment. Note: $0< p \\leq 1$, whereas $f[A|L]$ is the probability of treatment based on covariates L. A common choice is to use $Pr[A = 1]$ for $p$ in the treated and $Pr[A=0]$ for $p$ in the untreated. $Pr$ in this case means the proportion. More compactly:\n\n\n$$\n\\frac{f(A)}{f[A|L]}\n$$\n\n\n## Stabilized Weight\n\n\n$$\nSW^a = \\frac{f(A)}{f[A|L]}\n$$\n\n\nMean of the stabilized weights should be 1. This is important to check when conducting an analysis using stabilized weights.\n\n## Stabilized or Nonstabilized?\n\nAt this point, you may be wondering to yourself if we should be using stabilized or nonstabilized weights. One reason is stabilized weights result in narrower 95% CIs. You should use stabilized weights when your model is not saturated (i.e., there are the same amount of unknowns on both sides of the equations)\n\n## Example\n\nAn example always helps. Let's jump right into our made up dataset. We have 5 variables: sex, sunglasses, age, love for disney princess and ice cream eaters. Now for this dataset, we want to know if loving Disney movie causes people to become ice cream lovers. Below is a summary table of\n\n\n\n\n\n+-------------------------+----------------+------------------+\n| Variables               | Disney Lover   | Not a Disney Fan |\n|                         |                |                  |\n|                         | (n = 577)      | ( n = 206)       |\n+:=======================:+:==============:+:================:+\n| Age, mean (SD)          | 31.8 (16.3)    | 54.1 (16.0)      |\n+-------------------------+----------------+------------------+\n| Female, n (%)           | 110 (19.1%)    | 119, (57.8)      |\n+-------------------------+----------------+------------------+\n| Sunglasses, n (%)       | 209 (36.2%)    | 98 (47.6%)       |\n+-------------------------+----------------+------------------+\n| Ice Cream Lovers, n (%) | 126 (21.8%)    | 51 (24.8%)       |\n+-------------------------+----------------+------------------+\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}