---
title: "Causal Estimands" 
subtitle: "Who does this apply too?"
author: "Ryan Batten"
date: "2023-06-22"
categories: [Estimands, ATE, ATT, ATU]
# image : "standards.png"
bibliography: estimands.bib
draft: true
format: 
  html:
    toc: true
    toc-title: Contents
    toc-location: right
    toc-depth: 4
    code-fold: true
---

## Who does this apply too?

A key part of any research question is to determine who this applies too. There are several different ways to determine this but this post will focus on the causal estimand. Specifically, who does this result apply to? It's even more important when we have secondary data where patients aren't randomized to a treatment/group. Let's start with an example\

## Example

As per usual, time for an example! Say that we have a magical water gun that makes you grow taller. Before we do any analyses we need to setup our research question. In clinical epidemiology this is typically PICO(S): population, intervention, comparators, outcome and sometimes study design. The causal estimand helps us with the first letter: P by asking "who does this apply too?". Now the who refers to the target population, that is the people we are...well targeting (not necessarily those we sample and study).

For our study, we have two groups: monsters and kids. We want to figure out who the magically water gun will work on. Why? Well both monsters and kids are pretty short, their friends want to know if they will grow!

![**Kids and Monsters**](kids_monsters.png)

```{r, message = FALSE, warning = FALSE}

library(tidyverse)

n.monsters = 135
n.kids = 452

set.seed(135451)

monsters <- data.frame(
  eyes = runif(n.monsters, min = 1, max = 5),
  age = rnorm(n.monsters, mean = 200, sd = 50),
  group = 1
  # group = "monsters"
) %>% 
  dplyr::mutate(
  height = eyes*0.5 + age/1000,
  sprayed = rbinom(n.monsters, size = 1, prob = plogis(0.01*age + 0.2*eyes))
  )

kids <- data.frame(
  eyes = runif(n.kids, min = 2, max = 4), # some kids may be called "four eyes"
  age = rnorm(n.kids, mean = 5, sd = 1),
  group = 0
  # group = "kids"
) %>% 
  dplyr::mutate(
  height = eyes*0.5 + age/10,
  sprayed = rbinom(n.kids, size = 1, prob = plogis(0.2*age + 0.125*eyes))
  )

df <- rbind(
  monsters, 
  kids
)



```

|                             | Monsters (n = 135) | Kids ( n = 452)  |
|:---------------------------:|:------------------:|:----------------:|
|  Number of eyes, mean (SD)  |    2.99 (1.22)     |      2 (0)       |
|       Age, mean (SD)        |   206.90 (45.78)   |   5.16 (1.92)    |
| Sprayed by water gun, n (%) |    123 (91.1%)     |   328 (72.6%)    |
| Height (in feet), mean (SD) |    1.70 (0.61)     |   1.51 (0.19)    |

: **Characteristics of Monsters and Kids**

## Types of Estimands

We'll focus on four causal estimands, in no particular order:

-   Average treatment effect in the population (ATE)

-   Average treatment effect in the treated (ATT)

-   Average treatment effect in the untreated (ATU)

-   Average treatment effect in the overlap (ATO)

One important thing to note here is that all of these estimands would be the same in a randomized trial because the characteristics will be the same (at least in theory) Therefore the ATT, ATU and ATE will be the same. However, not so in observational data.

## Potential Outcomes

::: callout-note
An important part here is the potential outcomes framework. The potential outcomes can be written as $Y_0$ and $Y_i$. For a binary treatment, like in our case, we can think of it as each person has two potential outcomes (one if they get sprayed by the water gun, one if not). Depending on what happens, one of the outcomes is observed. \
\
Now, the individual causal effect is $Y_1$ - $Y_0$ for each person. We can't know this for each person, so instead we take an average (if we assume certain things). In math terms, we show this as $E[Y_{1} - Y_{0}]$.
:::

### ATE

The ATE is the the average treatment effect among all eligible patients in the study population (i.e., difference were they all to be treated vs were they all not to be treated) [@greifer2021choosing]. For our example, it would be the difference were all the monsters and kids sprayed with the water gun versus were the monster and kids not sprayed.

To estimate the ATE, we can use inverse probability weights.

```{r, message=FALSE, warning =FALSE}

# Note to self: example needs work. Weights are just proportions of each group (n.kids/n.total)

library(WeightIt)

mod <- glm()

w <- WeightIt::weightit(
  data = df,
  group ~ age + eyes, 
  method = "glm", 
  estimand = "ATE", 
  stabilize = FALSE
)

```

### ATT

In IPTW terms, those that received treatment receive a weight of 1.0 and those that received control they

Here, we're focusing on the kids who chose to get sprayed. So we ask, "What is the average effect on those kids who actually got sprayed with the Magic Growth Water?" That is, among kids who are already getting sprayed, how much taller are they on average because of the Magic Growth Water?

### ATU

In IPTW terms, those that received placebo (control) receive a weight of 1.0 and those that were treated are weighted.

This is the opposite of ATT. It's like asking, "What would be the average effect on those kids who didn't get sprayed if they started getting sprayed?" So, among kids who don't currently get sprayed, how much taller would they be on average if they started getting sprayed?

### ATO

ATO is the average treatment in the overalp.

## Adjustment Techniques

Picking the estimand of interest isn't just important for the target population but also for the adjustment technique selected. Certain ones can only target certain estimands. This becomes even more important when you are comparing methods. For example, IPW and PSM do not target the same estimand [@greifer2021choosing].
