<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Batten">
<meta name="dcterms.date" content="2024-02-15">

<title>Blog Posts - Emulating a Target Trial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog Posts</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/rwe-ryan" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/rwe_ryan" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/battenr" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Emulating a Target Trial</h1>
            <p class="subtitle lead">Lessons Learned</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Target Trial</div>
                <div class="quarto-category">Lessons Learned</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ryan Batten </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#what-is-a-target-trial-why-emulate-one" id="toc-what-is-a-target-trial-why-emulate-one" class="nav-link active" data-scroll-target="#what-is-a-target-trial-why-emulate-one">What is a Target Trial? Why Emulate One?</a></li>
  <li><a href="#lessons-learned" id="toc-lessons-learned" class="nav-link" data-scroll-target="#lessons-learned">Lessons Learned</a></li>
  <li><a href="#inclusionexclusion-criteria" id="toc-inclusionexclusion-criteria" class="nav-link" data-scroll-target="#inclusionexclusion-criteria">Inclusion/Exclusion Criteria</a>
  <ul>
  <li><a href="#applying-all-ie-criteria-is-unlikely" id="toc-applying-all-ie-criteria-is-unlikely" class="nav-link" data-scroll-target="#applying-all-ie-criteria-is-unlikely">Applying All I/E Criteria is Unlikely</a></li>
  <li><a href="#how-can-we-alter-criteria" id="toc-how-can-we-alter-criteria" class="nav-link" data-scroll-target="#how-can-we-alter-criteria">How Can We Alter Criteria?</a></li>
  </ul></li>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">Data Sources</a></li>
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link" data-scroll-target="#missing-data">Missing Data</a>
  <ul>
  <li><a href="#need-a-plan" id="toc-need-a-plan" class="nav-link" data-scroll-target="#need-a-plan">Need a Plan</a></li>
  <li><a href="#missing-data-mechanism-for-each-variable" id="toc-missing-data-mechanism-for-each-variable" class="nav-link" data-scroll-target="#missing-data-mechanism-for-each-variable">Missing Data Mechanism for Each Variable</a></li>
  </ul></li>
  <li><a href="#index-dates" id="toc-index-dates" class="nav-link" data-scroll-target="#index-dates">Index Dates</a>
  <ul>
  <li><a href="#too-many-options" id="toc-too-many-options" class="nav-link" data-scroll-target="#too-many-options">Too many options!</a></li>
  </ul></li>
  <li><a href="#causal-estimands" id="toc-causal-estimands" class="nav-link" data-scroll-target="#causal-estimands">Causal Estimands</a></li>
  <li><a href="#simulating-situations" id="toc-simulating-situations" class="nav-link" data-scroll-target="#simulating-situations">Simulating Situations!</a>
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="what-is-a-target-trial-why-emulate-one" class="level1">
<h1>What is a Target Trial? Why Emulate One?</h1>
<p>A target trial is the trial that we’d like to conduct under ideal circumstances. Emulating a target trial consists of trying to mimic this trial as much as possible given the constraints (i.e., ethics, data availability, etc). For example, the target trial may be randomizing patients but we can’t randomize patients that are in an observational study. For a brief overview of emulating a target trial, I’d recommend reading <span class="citation" data-cites="hernan2016using">Hernán and Robins (<a href="#ref-hernan2016using" role="doc-biblioref">2016</a>)</span> or <span class="citation" data-cites="fu2023target">Fu (<a href="#ref-fu2023target" role="doc-biblioref">2023</a>)</span>.</p>
<p>Target trial emulation has drastically improved the quality of studies using observational data in recent years. It can prevent a lot of biases that are “self-inflicted” such as immortal time bias <span class="citation" data-cites="hernan2016specifying">(<a href="#ref-hernan2016specifying" role="doc-biblioref">Hernán et al. 2016</a>)</span>. Although the concept may seem simple at first (or so I thought), in practice there are some challenges that can arise. This post focuses on my personal experience with emulating target trials and what I’ve learned.</p>
</section>
<section id="lessons-learned" class="level1">
<h1>Lessons Learned</h1>
<p>I’ve been involved with a few projects where the goal is to emulate a target trial. Part of my PhD project, currently underway, is to emulate a target trial using electronic health records. There are some lessons that I’ve learned along the way. To keep it somewhat organized, I’ll group them into categories:</p>
<ul>
<li><p>Inclusion/Exclusion Criteria</p></li>
<li><p>Data Sources</p></li>
<li><p>Missing Data</p></li>
<li><p>Index Dates</p></li>
<li><p>Causal Estimands</p></li>
</ul>
</section>
<section id="inclusionexclusion-criteria" class="level1">
<h1>Inclusion/Exclusion Criteria</h1>
<p>Inclusion/exclusion (I/E) criteria, sometimes referred to as eligibility criteria, are required for a few reasons including including patients needed to answer the research question and for internal validity. A difference between applying I/E criteria in a randomized controlled trial (RCT) and using real-world data (RWD) is the flexibility.</p>
<section id="applying-all-ie-criteria-is-unlikely" class="level2">
<h2 class="anchored" data-anchor-id="applying-all-ie-criteria-is-unlikely">Applying All I/E Criteria is Unlikely</h2>
<p>For the target trial, <strong>all</strong> I/E criteria would be applied. Unfortunately, this is unlikely to be the case for emulating a target trial. What can further complicate it, is that different data sources may have different variables which will allow for different criteria to be applied. This can make it tricky to decide what to do.</p>
<p>An approach that I find useful, is the one outlined in <span class="citation" data-cites="gatto2022structured">Gatto et al. (<a href="#ref-gatto2022structured" role="doc-biblioref">2022</a>)</span>. This helps rank which criteria are most important so be applied to allow for a better decision. It also helps decide what are the minimum criteria (i.e., non-negotiable) required to answer the research question.</p>
</section>
<section id="how-can-we-alter-criteria" class="level2">
<h2 class="anchored" data-anchor-id="how-can-we-alter-criteria">How Can We Alter Criteria?</h2>
<p>The data has already been collected for RWD which is a limitation. For example, a lab test might measured within 30 days prior to starting treatment. For real-world data, the lab test might not be measured within 30 days.</p>
<p>This doesn’t mean that we can’t apply the criteria, it just requires some modification. This often requires input from an expert (i.e., a clinician). For example, the ideal criteria might be to take a lab value the day before randomization but this isn’t available in the RWD. So what’s a reasonable alternative? 14 days? A week? A month?</p>
<p>The goal is to modify the criteria to be as similar as the ideal criteria while not sacrificing the validity of the study.</p>
</section>
</section>
<section id="data-sources" class="level1">
<h1>Data Sources</h1>
<p>A large part of emulating a target trial is deciding which data source to use. There are several factors to consider including the data quality, rate of missingness, variables captured and more. The most important component is “can this answer the research question?”. There is a wide variety of great sources of data including claims data, electronic health records, registry data and wearables (i.e., trackers, etc).</p>
<p>There’s limitations/tradeoffs for each of them. For example, claims data will have information about costs but electronic health records and registry data won’t. However, both of these will typically have more detail than claims (i.e., lab tests, physician notes, etc). An article that helped me when considering multiple data sources is <span class="citation" data-cites="gatto2022structured">Gatto et al. (<a href="#ref-gatto2022structured" role="doc-biblioref">2022</a>)</span>.</p>
</section>
<section id="missing-data" class="level1">
<h1>Missing Data</h1>
<p>If you’re working with real-world data, there will 100% be missing data. Having a plan for how to address this helps. My overall takeaway for missing data is to start with “how did this data become missing?”</p>
<section id="need-a-plan" class="level2">
<h2 class="anchored" data-anchor-id="need-a-plan">Need a Plan</h2>
<p>Working with real-world data, you will need a plan for missing data. Regardless of how high quality the data is you will need a plan. Personally, I tend to separate these into two main categories. The two main categories are: covariates and outcomes. The reason for this is the method used to solve these can differ.</p>
<p>Part of what can make this challenging (not just for emulating a target trial but missing data in general, including trials) is that you don’t see the data <em>a priori.</em> However, the rate of missingness can be guessed reasonably, and the assumed missing data mechanism.</p>
</section>
<section id="missing-data-mechanism-for-each-variable" class="level2">
<h2 class="anchored" data-anchor-id="missing-data-mechanism-for-each-variable">Missing Data Mechanism for Each Variable</h2>
<p>The missing data mechanism can be different for each variable. This was something that I hadn’t thought about before working on a project where the team specified a different missing data mechanism (MCAR, MAR, MNAR) for each variable. To me, this became a fantastic approach because a “one-size approach fits all” mentality is dangerous if applying to all variables. Not every variable is missing due to the same reason.</p>
</section>
</section>
<section id="index-dates" class="level1">
<h1>Index Dates</h1>
<p>Choosing an index date, the time point that we start measuring follow-up from, can seem fairly straightforward. Based on emulating a trial, if the goal is to estimate the per-protocol effects, then we can select the index date as 1 day after receiving treatment or whatever will align with our target trial….but what if there are multiple options?</p>
<section id="too-many-options" class="level2">
<h2 class="anchored" data-anchor-id="too-many-options">Too many options!</h2>
<p>Depending on the disease area, it’s possible that there are multiple possible index dates. Prior to coming across this issue, I had naively assumed there’d only be one index date. This becomes problematic. Do we pick the first index date? The last? Randomly close our eyes and pick one while hoping for the best?<br>
<br>
Like much of science the answer is “it depends”. Part of the reason is that it depends on the outcome. If it’s a time-to-event outcome, choosing the first or last index date could impact the results. My approach now when I come across this problem is to simulate the scenario, similar to <span class="citation" data-cites="hatswell2022approaches">Hatswell et al. (<a href="#ref-hatswell2022approaches" role="doc-biblioref">2022</a>)</span>.</p>
</section>
</section>
<section id="causal-estimands" class="level1">
<h1>Causal Estimands</h1>
<p>Causal estimands differ from the estimands referred to in a clinical trial setting (the ICH E9 (R1) addendum estimands). Learning about these causal estimands helped tremendously when trying to determine what type of method to use for controlling for confounding and for guiding the research question. These estimands are: the average treatment effect (ATE), the average treatment effect in the treated (ATT), the average treated effect in the untreated (ATU) and the average treatment effect in the overlap (ATO).</p>
<p>If you are not familiar with causal estimands, like I wasn’t, I highly recommend <span class="citation" data-cites="greifer2023choosing">Greifer and Stuart (<a href="#ref-greifer2023choosing" role="doc-biblioref">2023</a>)</span>.</p>
</section>
<section id="simulating-situations" class="level1">
<h1>Simulating Situations!</h1>
<p>One of the biggest lessons for me, was learning to simulate data. This can help when there isn’t necessarily a consensus on a method or a solution to the problem that you’re currently facing. I would recommend learning how to simulate data to be able to answer questions that may arise when working on emulating a target trial.</p>
<section id="section" class="level2">




</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-fu2023target" class="csl-entry" role="listitem">
Fu, Edouard L. 2023. <span>“Target Trial Emulation to Improve Causal Inference from Observational Data: What, Why, and How?”</span> <em>Journal of the American Society of Nephrology</em> 34 (8): 1305–14.
</div>
<div id="ref-gatto2022structured" class="csl-entry" role="listitem">
Gatto, Nicolle M, Ulka B Campbell, Emily Rubinstein, Ashley Jaksa, Pattra Mattox, Jingping Mo, and Robert F Reynolds. 2022. <span>“The Structured Process to Identify Fit-for-Purpose Data: A Data Feasibility Assessment Framework.”</span> <em>Clinical Pharmacology &amp; Therapeutics</em> 111 (1): 122–34.
</div>
<div id="ref-greifer2023choosing" class="csl-entry" role="listitem">
Greifer, N, and EA Stuart. 2023. <span>“Choosing the Causal Estimand for Propensity Score Analysis of Observational Studies.”</span> <em>arXiv Preprint arXiv:2106.10577</em>.
</div>
<div id="ref-hatswell2022approaches" class="csl-entry" role="listitem">
Hatswell, Anthony J, Kevin Deighton, Julia Thornton Snider, M Alan Brookhart, Imi Faghmous, and Anik R Patel. 2022. <span>“Approaches to Selecting <span>‘Time Zero’</span> in External Control Arms with Multiple Potential Entry Points: A Simulation Study of 8 Approaches.”</span> <em>Medical Decision Making</em> 42 (7): 893–905.
</div>
<div id="ref-hernan2016using" class="csl-entry" role="listitem">
Hernán, Miguel A, and James M Robins. 2016. <span>“Using Big Data to Emulate a Target Trial When a Randomized Trial Is Not Available.”</span> <em>American Journal of Epidemiology</em> 183 (8): 758–64.
</div>
<div id="ref-hernan2016specifying" class="csl-entry" role="listitem">
Hernán, Miguel A, Brian C Sauer, Sonia Hernández-Dı́az, Robert Platt, and Ian Shrier. 2016. <span>“Specifying a Target Trial Prevents Immortal Time Bias and Other Self-Inflicted Injuries in Observational Analyses.”</span> <em>Journal of Clinical Epidemiology</em> 79: 70–75.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>