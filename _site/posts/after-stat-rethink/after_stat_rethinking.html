<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Batten">
<meta name="dcterms.date" content="2025-01-06">

<title>Blog Posts - My Misconceptions About Bayesian Statistics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog Posts</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/rwe-ryan"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/rwe_ryan"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/battenr"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">My Misconceptions About Bayesian Statistics</h1>
            <p class="subtitle lead">After Reading Statistical Rethinking</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Bayes</div>
                <div class="quarto-category">Bayesian Statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ryan Batten </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 6, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#why-this-post-why-now" id="toc-why-this-post-why-now" class="nav-link active" data-scroll-target="#why-this-post-why-now">Why This Post? Why Now?</a></li>
  <li><a href="#prior-thinking" id="toc-prior-thinking" class="nav-link" data-scroll-target="#prior-thinking">Prior Thinking</a></li>
  <li><a href="#priors-can-lead-to-guiding-the-analysis" id="toc-priors-can-lead-to-guiding-the-analysis" class="nav-link" data-scroll-target="#priors-can-lead-to-guiding-the-analysis">Priors Can Lead to “Guiding” the Analysis</a></li>
  <li><a href="#the-prior-will-take-over" id="toc-the-prior-will-take-over" class="nav-link" data-scroll-target="#the-prior-will-take-over">The Prior Will Take Over!</a></li>
  <li><a href="#priors-alter-the-data" id="toc-priors-alter-the-data" class="nav-link" data-scroll-target="#priors-alter-the-data">Priors Alter the Data!</a></li>
  <li><a href="#the-prior-has-to-be-the-same-for-all-variables" id="toc-the-prior-has-to-be-the-same-for-all-variables" class="nav-link" data-scroll-target="#the-prior-has-to-be-the-same-for-all-variables">The Prior Has to Be the Same for All Variables</a></li>
  <li><a href="#the-credible-interval-is-just-a-way-to-avoid-the-p-value" id="toc-the-credible-interval-is-just-a-way-to-avoid-the-p-value" class="nav-link" data-scroll-target="#the-credible-interval-is-just-a-way-to-avoid-the-p-value">The Credible Interval is Just a Way to Avoid the P-Value</a></li>
  <li><a href="#they-give-the-same-or-similar-answer-as-frequentist-methods" id="toc-they-give-the-same-or-similar-answer-as-frequentist-methods" class="nav-link" data-scroll-target="#they-give-the-same-or-similar-answer-as-frequentist-methods">They Give the Same (or Similar) Answer as Frequentist Methods</a></li>
  <li><a href="#my-computer-will-explode-if-i-try-to-use-mcmc" id="toc-my-computer-will-explode-if-i-try-to-use-mcmc" class="nav-link" data-scroll-target="#my-computer-will-explode-if-i-try-to-use-mcmc">My Computer Will Explode if I Try to Use MCMC</a></li>
  <li><a href="#need-to-fully-understand-the-algorithm-before-using" id="toc-need-to-fully-understand-the-algorithm-before-using" class="nav-link" data-scroll-target="#need-to-fully-understand-the-algorithm-before-using">Need to Fully Understand The Algorithm Before Using</a></li>
  <li><a href="#bayesian-methods-are-overly-complicated" id="toc-bayesian-methods-are-overly-complicated" class="nav-link" data-scroll-target="#bayesian-methods-are-overly-complicated">Bayesian Methods Are Overly Complicated</a></li>
  <li><a href="#bayesian-methods-are-vastly-different-from-frequentists" id="toc-bayesian-methods-are-vastly-different-from-frequentists" class="nav-link" data-scroll-target="#bayesian-methods-are-vastly-different-from-frequentists">Bayesian Methods are Vastly Different from Frequentists</a></li>
  <li><a href="#the-diagnostics-are-complicated" id="toc-the-diagnostics-are-complicated" class="nav-link" data-scroll-target="#the-diagnostics-are-complicated">The Diagnostics are Complicated</a></li>
  <li><a href="#bonus" id="toc-bonus" class="nav-link" data-scroll-target="#bonus">Bonus!</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="why-this-post-why-now" class="level2">
<h2 class="anchored" data-anchor-id="why-this-post-why-now">Why This Post? Why Now?</h2>
<p>Recently, end of 2024, I finished reading Statistical Rethinking by Richard McElreath. I had come across the book several times on social media and recommendations by colleagues/friends. I decided to dive into it finally.</p>
<p>Before reading this, I had limited knowledge about Bayesian methods. The goal of this post is to explain what some of these prior misconceptions were, and why they’re misguided. Hopefully you find this useful,</p>
</section>
<section id="prior-thinking" class="level2">
<h2 class="anchored" data-anchor-id="prior-thinking">Prior Thinking</h2>
<p>My background was in frequentist statistics. I had been adjacent to Bayesian methods but never used them. There were several misconceptions that I had about Bayesian stats before diving into it. My goal with this post is to try to explain why some of the things I had previously thought (you may too) are incorrect or perhaps only slightly too.</p>
<p>Let’s dive in!</p>
</section>
<section id="priors-can-lead-to-guiding-the-analysis" class="level2">
<h2 class="anchored" data-anchor-id="priors-can-lead-to-guiding-the-analysis">Priors Can Lead to “Guiding” the Analysis</h2>
<p>Truth: If not enough data you’ll just get the priors back.</p>
<p>At the essence of Bayesian statistics is being able to show the full degree of uncertainty. This is done through Bayes’ Theorem:</p>
<p>P(A|B) = P(B|A) * P (B) / P(A)</p>
<p>Basically this means that we have some priors, then we want to incorporate with the data to get a posterior.</p>
<p>The tricky part becomes “How do I choose a prior?”. I used to think that priors could be selected to be intentionally misleading/get the answer you want. The truth is that is true for basically any of science.</p>
<p>With science, we make assumptions. Priors are just an assumption (or an educated guess). Is that guess correct? Maybe. Maybe not. The bonus is being upfront about it allows us to have those debates and conversations. This is akin to drawing a directed acylic graph. Is a DAG correct? Maybe. Maybe not. But by being transparent about our assumptions it helps those conversations.</p>
</section>
<section id="the-prior-will-take-over" class="level2">
<h2 class="anchored" data-anchor-id="the-prior-will-take-over">The Prior Will Take Over!</h2>
<p>Truth: the data has a lot to say about that.</p>
<p>Here’s the thing: that can happen sometimes. The best way to tell is to plot your prior, fit your model, include the data and look at the posterior. If the data is the same as your prior…you need to collect some more data.</p>
</section>
<section id="priors-alter-the-data" class="level2">
<h2 class="anchored" data-anchor-id="priors-alter-the-data">Priors Alter the Data!</h2>
<p>Truth: Not accurate</p>
<p>The priors are for the parameters and intercepts. These aren’t changing the data.</p>
<p>For example, take y = mx + b</p>
<p>y and x are from the data. We’re estimating m and b. So this is where the priors go.</p>
</section>
<section id="the-prior-has-to-be-the-same-for-all-variables" class="level2">
<h2 class="anchored" data-anchor-id="the-prior-has-to-be-the-same-for-all-variables">The Prior Has to Be the Same for All Variables</h2>
<p>Truth: They don’t</p>
<p>A cool thing about priors is you can set different ones for different variables. So why does this matter? Well, the treatment effect that we think is possible may be different than what we think the possible effect of</p>
</section>
<section id="the-credible-interval-is-just-a-way-to-avoid-the-p-value" class="level2">
<h2 class="anchored" data-anchor-id="the-credible-interval-is-just-a-way-to-avoid-the-p-value">The Credible Interval is Just a Way to Avoid the P-Value</h2>
<p>At this point you might be thinking “Oh dear god, god, dear god, noooooooo!” [Ryan insert gif of Michael Scott]</p>
<p>Truth: It could be used for this purpose but not for the reason you think.</p>
<p>This is no different from any other method. A credible interval could be used to avoid a p-value however, that would require a few things. If it were being used solely for that purpose, there would be some potential “signs”.</p>
<p>The whole concept is to highlight the uncertainty. To me, dwindling this down to a simple interval doesn’t really do the Bayes approach justice. However it does make it more interpretable than a confidence interval.</p>
<p>Additionally, if we wanted to calculate a version of the p-value we still could with the distribution (although it would kinda defeat the purpose of Bayesian methods [that is narrowing the uncertainty down to a single point estimate[):</p>
<p>P(Data | Null True) = P(Null True | Data) * P(Data) / P (Null True)</p>
</section>
<section id="they-give-the-same-or-similar-answer-as-frequentist-methods" class="level2">
<h2 class="anchored" data-anchor-id="they-give-the-same-or-similar-answer-as-frequentist-methods">They Give the Same (or Similar) Answer as Frequentist Methods</h2>
<p>Truth: It depends.</p>
<p>Both approaches certainly can give similar methods however there’s a few key differences:</p>
<ol type="1">
<li>The priors - A frequentist approach starts with the effect being able to be anywhere between - infinity and + infinity. Obviously there are some problems with this approach</li>
<li>The flexibility</li>
</ol>
<p>The second bullet point is where I think there is a lot to be gained. From using this approach</p>
</section>
<section id="my-computer-will-explode-if-i-try-to-use-mcmc" class="level2">
<h2 class="anchored" data-anchor-id="my-computer-will-explode-if-i-try-to-use-mcmc">My Computer Will Explode if I Try to Use MCMC</h2>
<p>Okay, that’s a little overzealous.</p>
<p>Truth: Computing can be problematic with Bayesian methods but in today’s world it’s really not so bad.</p>
<p>As a side note: there is some truth to the extra computation. However, one of the best ways to work around this is to be smart with how many times you’re running the model</p>
<ul>
<li><p>Think before running it</p></li>
<li><p>Do a test run first (limit the resources, like the chain, etc)</p></li>
</ul>
</section>
<section id="need-to-fully-understand-the-algorithm-before-using" class="level2">
<h2 class="anchored" data-anchor-id="need-to-fully-understand-the-algorithm-before-using">Need to Fully Understand The Algorithm Before Using</h2>
<p>Truth: You need to understand it, but the basics will do.</p>
<p>At first, I thought that I needed to completely understand the algorithm. As in understanding the underlying programming to build a sampler.</p>
<p>While this would be helpful, there are limitations to everyone’s knowledge. This is the equivalent of saying to apply generalized linear models (GLMs), you need to understand the equations underlying the model with matrices.</p>
</section>
<section id="bayesian-methods-are-overly-complicated" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-methods-are-overly-complicated">Bayesian Methods Are Overly Complicated</h2>
<p>Truth: Yes, but no more than any other method.</p>
<p>Every method is complicated when you first learn it. The key is to start with the basics.</p>
<p>The method that you find easy? That method is complicated to someone else.</p>
</section>
<section id="bayesian-methods-are-vastly-different-from-frequentists" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-methods-are-vastly-different-from-frequentists">Bayesian Methods are Vastly Different from Frequentists</h2>
<p>Truth: both use likelihoods</p>
</section>
<section id="the-diagnostics-are-complicated" class="level2">
<h2 class="anchored" data-anchor-id="the-diagnostics-are-complicated">The Diagnostics are Complicated</h2>
<p>Truth: some, others not so much</p>
<p>Its fairly simple really.</p>
<ul>
<li><p>Check the pp_check() which looks at the posterior</p></li>
<li><p>Predictive prior check</p></li>
<li><p>Traceplots</p></li>
<li><p>Trankplots</p></li>
</ul>
</section>
<section id="bonus" class="level2">
<h2 class="anchored" data-anchor-id="bonus">Bonus!</h2>
<p>A bonus if you can set a prior, and check model first. THEN you can incorporate your data</p>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>