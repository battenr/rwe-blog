<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Batten">
<meta name="dcterms.date" content="2023-11-26">

<title>Blog Posts - Missing Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog Posts</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../consulting.html" rel="" target="">
 <span class="menu-text">Consulting</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/rwe-ryan" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/rwe_ryan" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/battenr" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Missing Data</h1>
            <p class="subtitle lead">The Where’s Waldo of Causal Inference</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Missing Data</div>
                <div class="quarto-category">MCAR</div>
                <div class="quarto-category">MAR</div>
                <div class="quarto-category">MNAR</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ryan Batten </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 26, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link active" data-scroll-target="#missing-data">Missing Data</a></li>
  <li><a href="#missing-data-mechanisms" id="toc-missing-data-mechanisms" class="nav-link" data-scroll-target="#missing-data-mechanisms">Missing Data Mechanisms</a>
  <ul>
  <li><a href="#missing-completely-at-random-mcar" id="toc-missing-completely-at-random-mcar" class="nav-link" data-scroll-target="#missing-completely-at-random-mcar">Missing Completely at Random (MCAR)</a></li>
  <li><a href="#missing-at-random-mar" id="toc-missing-at-random-mar" class="nav-link" data-scroll-target="#missing-at-random-mar">Missing at Random (MAR)</a></li>
  <li><a href="#missing-not-at-random-mnar" id="toc-missing-not-at-random-mnar" class="nav-link" data-scroll-target="#missing-not-at-random-mnar">Missing Not at Random (MNAR)</a></li>
  </ul></li>
  <li><a href="#pirate-treasure" id="toc-pirate-treasure" class="nav-link" data-scroll-target="#pirate-treasure">Pirate Treasure?</a></li>
  <li><a href="#sowhat-do-we-do" id="toc-sowhat-do-we-do" class="nav-link" data-scroll-target="#sowhat-do-we-do">So…what do we do?</a></li>
  <li><a href="#complete-cases-exclude-all-missing" id="toc-complete-cases-exclude-all-missing" class="nav-link" data-scroll-target="#complete-cases-exclude-all-missing">Complete Cases (Exclude All Missing)</a>
  <ul>
  <li><a href="#what-is-it" id="toc-what-is-it" class="nav-link" data-scroll-target="#what-is-it">What is it?</a></li>
  <li><a href="#when-to-use" id="toc-when-to-use" class="nav-link" data-scroll-target="#when-to-use">When to Use</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#considerations" id="toc-considerations" class="nav-link" data-scroll-target="#considerations">Considerations</a></li>
  </ul></li>
  <li><a href="#last-observation-carried-forward" id="toc-last-observation-carried-forward" class="nav-link" data-scroll-target="#last-observation-carried-forward">Last Observation Carried Forward</a>
  <ul>
  <li><a href="#what-is-it-1" id="toc-what-is-it-1" class="nav-link" data-scroll-target="#what-is-it-1">What is it?</a></li>
  <li><a href="#when-to-use-1" id="toc-when-to-use-1" class="nav-link" data-scroll-target="#when-to-use-1">When to Use</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  <li><a href="#considerations-1" id="toc-considerations-1" class="nav-link" data-scroll-target="#considerations-1">Considerations</a></li>
  </ul></li>
  <li><a href="#mean-value-imputation" id="toc-mean-value-imputation" class="nav-link" data-scroll-target="#mean-value-imputation">Mean Value Imputation</a>
  <ul>
  <li><a href="#what-is-it-2" id="toc-what-is-it-2" class="nav-link" data-scroll-target="#what-is-it-2">What is it?</a></li>
  <li><a href="#when-to-use-2" id="toc-when-to-use-2" class="nav-link" data-scroll-target="#when-to-use-2">When to Use</a></li>
  <li><a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2">Example</a></li>
  <li><a href="#considerations-2" id="toc-considerations-2" class="nav-link" data-scroll-target="#considerations-2">Considerations</a></li>
  </ul></li>
  <li><a href="#condition-mean-imputation-aka-using-regression" id="toc-condition-mean-imputation-aka-using-regression" class="nav-link" data-scroll-target="#condition-mean-imputation-aka-using-regression">Condition mean Imputation (aka using Regression)</a>
  <ul>
  <li><a href="#what-is-it-3" id="toc-what-is-it-3" class="nav-link" data-scroll-target="#what-is-it-3">What is it?</a></li>
  <li><a href="#when-to-use-3" id="toc-when-to-use-3" class="nav-link" data-scroll-target="#when-to-use-3">When to Use</a></li>
  <li><a href="#example-3" id="toc-example-3" class="nav-link" data-scroll-target="#example-3">Example</a></li>
  <li><a href="#considerations-3" id="toc-considerations-3" class="nav-link" data-scroll-target="#considerations-3">Considerations</a></li>
  </ul></li>
  <li><a href="#multiple-imputation" id="toc-multiple-imputation" class="nav-link" data-scroll-target="#multiple-imputation">Multiple Imputation</a>
  <ul>
  <li><a href="#what-is-it-4" id="toc-what-is-it-4" class="nav-link" data-scroll-target="#what-is-it-4">What is it?</a></li>
  <li><a href="#when-to-use-4" id="toc-when-to-use-4" class="nav-link" data-scroll-target="#when-to-use-4">When to Use</a></li>
  <li><a href="#example-4" id="toc-example-4" class="nav-link" data-scroll-target="#example-4">Example</a></li>
  <li><a href="#considerations-4" id="toc-considerations-4" class="nav-link" data-scroll-target="#considerations-4">Considerations</a></li>
  </ul></li>
  <li><a href="#summary-of-methods" id="toc-summary-of-methods" class="nav-link" data-scroll-target="#summary-of-methods">Summary of Methods</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="missing-data" class="level1">
<h1>Missing Data</h1>
<p>Missing data are unavoidable when dealing with data, especially with real-world data. So it’s important to have a plan on what to do with missing data! To make valid causal inferences, we need to have a solution but what options do we have? A BUNCH! This post will focus on introducing five common methods:</p>
<ul>
<li><p>Complete Case</p></li>
<li><p>Last Observation Carried Forward</p></li>
<li><p>Mean Value Imputation</p></li>
<li><p>Conditional Mean Imputation (aka using regression)</p></li>
<li><p>Multiple Imputation</p></li>
</ul>
<p>Before we dive into these, first we need to go over the different types of missing data mechanisms. Arguably the most important aspect of dealing with missing data is figuring this part out.</p>
</section>
<section id="missing-data-mechanisms" class="level1">
<h1>Missing Data Mechanisms</h1>
<p>“How did this data end up becoming missing?” is basically what we are trying to figure out. Was this just random? Or is there a reason? Data can go missing for a variety of reasons. A patient refusing to respond to a certain question, being lost to follow-up, investigator error or certain tests not being order to name just a few.</p>
<p>Typically missing data are grouped into three types of missing data mechanisms: missing completely at random (MCAR), missing at random (MAR) and missing not a random (MNAR) <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span> . Let’s break down each one a little further.</p>
<section id="missing-completely-at-random-mcar" class="level2">
<h2 class="anchored" data-anchor-id="missing-completely-at-random-mcar">Missing Completely at Random (MCAR)</h2>
<p>Data are “missing completely at random” if the probability of a variable being missing is independent from both observed and unobserved variables for that person <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. The key word here is “completely”, implying that it has nothing to do with the other variables that we are interested in.</p>
<p>Let’s use an example. Imagine that we are taking a survey of a class of kindergarten children on what type of ice cream they ate. One day a mischievous puppy runs into the classroom and knocks over the box, and eats the surveys that fall out. The surveys that are missing are MCAR because it the dog didn’t choose which ones to eat! It was just an accident.</p>
</section>
<section id="missing-at-random-mar" class="level2">
<h2 class="anchored" data-anchor-id="missing-at-random-mar">Missing at Random (MAR)</h2>
<p>Data are “missing at random” if the probability of a variable being missing, after accounting for <strong>all</strong> the observed variables is independent from the unobserved data <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. So basically it can depend on the observed variables but has nothing to do with the unobserved variables.</p>
<p>Using our same example, imagine that kids who prefer mint or vanilla, decide to skip school and go to the beach. On those days when the teacher does the survey, the missing responses are more likely to be from kids who prefer those flavors. This would be MAR because it’s dependent on the fact that these kids are more likely to be absent when it’s hot.</p>
</section>
<section id="missing-not-at-random-mnar" class="level2">
<h2 class="anchored" data-anchor-id="missing-not-at-random-mnar">Missing Not at Random (MNAR)</h2>
<p>Data are considered to be “missing not at random” if, they are neither MCAR or MAR. But that’s not super helpful, let’s try again. Data are MNAR if the probability of being missing, even after accounting for all the observed variables, is based on the value of the missing variable <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>.</p>
<p>Using our example again, imagine that some kids like a rare flavor like blueberry-cucumber. These kids are afraid that others might find it strange so whenever the survey is handed out they don’t submit their surveys. This would be MNAR because it’s directly related to the data itself.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MAR vs MNAR
</div>
</div>
<div class="callout-body-container callout-body">
<p>Unfortunately, there is no way to test for MAR vs MNAR, so this needs to be based on expert knowledge <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>.</p>
</div>
</div>
</section>
</section>
<section id="pirate-treasure" class="level1">
<h1>Pirate Treasure?</h1>
<p>In order to illustrate how these data may look, we need to simulate some data! Imagine that we have a collection of pirate treasure maps. The missing data mechanisms could be thought of like this:<br>
<br>
<strong>MCAR</strong>: Some maps are missing because they were randomly lost during a storm at sea</p>
<p><strong>MAR</strong>: Maps are missing for treasures buried in a haunted island because superstitious pirates (whose superstitions are recorded) avoid those places.<br>
<br>
<strong>MNAR</strong>: Maps are missing for the most valuable treasures because the pirates who buried them never shared the locations, fearing theft, and their level of paranoia isn’t recorded. (So the most lucrative treasures are missing)</p>
<p>Let’s simulate some data for our pirate treasure example. We can then use this to show how we might solve these different ways.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># Loading tidyverse package</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># setting seed for reproducibility</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">322</span> <span class="co"># arbitrarily picked using runif(1, min = 100, max = 500)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pirate Data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pirate_id =</span> <span class="dv">1</span><span class="sc">:</span>n, </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">treasure_value =</span> <span class="fu">runif</span>(<span class="at">n =</span> n, <span class="at">min =</span> <span class="dv">1000</span>, <span class="at">max =</span> <span class="dv">5000</span>), </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">haunted_island =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">pirate_superstition =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># MCAR: Randomly select 50 observations</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>mcar_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df), <span class="dv">50</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>treasure_value_mcar <span class="ot">&lt;-</span> df<span class="sc">$</span>treasure_value</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>treasure_value_mcar[mcar_indices] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># MAR: Depends on the value of another variable</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>treasure_value_mar <span class="ot">&lt;-</span> df<span class="sc">$</span>treasure_value</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>is_mar <span class="ot">&lt;-</span> df<span class="sc">$</span>haunted_island <span class="sc">&amp;</span> df<span class="sc">$</span>pirate_superstition</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>treasure_value_mar[is_mar] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># MNAR: Higher value, higher chance of being NA</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>treasure_value_mnar <span class="ot">&lt;-</span> df<span class="sc">$</span>treasure_value</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>mnar_prob <span class="ot">&lt;-</span> df<span class="sc">$</span>treasure_value <span class="sc">/</span> <span class="fu">max</span>(df<span class="sc">$</span>treasure_value)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>treasure_value_mnar[<span class="fu">runif</span>(<span class="fu">nrow</span>(df)) <span class="sc">&lt;</span> mnar_prob] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df) <span class="co"># Viewing the data </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  pirate_id treasure_value haunted_island pirate_superstition
1         1       2150.310              0                   0
2         2       4153.221              1                   1
3         3       2635.908              0                   1
4         4       4532.070              0                   0
5         5       4761.869              1                   0
6         6       1182.226              0                   1
  treasure_value_mcar treasure_value_mar treasure_value_mnar
1            2150.310           2150.310                  NA
2            4153.221                 NA                  NA
3            2635.908           2635.908                  NA
4                  NA           4532.070                  NA
5            4761.869           4761.869            4761.869
6            1182.226           1182.226            1182.226</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for Selecting Appropriate Data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_missing <span class="ot">&lt;-</span> <span class="cf">function</span>(type){</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">"mcar"</span>){</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        pirate_id, </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        treasure_value, </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        haunted_island, </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        pirate_superstition,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        treasure_value_mcar</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"mar"</span>){</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        pirate_id, </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        treasure_value, </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        haunted_island, </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        pirate_superstition,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        treasure_value_mar</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"mnar"</span>){</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span> </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        pirate_id, </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        treasure_value, </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        haunted_island, </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        pirate_superstition,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        treasure_value_mnar</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error: Please select one of the types of missing data mechanisms (MCAR, MAR, MNAR)"</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sowhat-do-we-do" class="level1">
<h1>So…what do we do?</h1>
<p>Once we know, or make an assumption about, what type of missing data mechanism we have we need to figure out how to deal with this! This post will go over five methods, although there a LOT more than that. These are just some common ones that I see/have come across in my field (clinical epidemiology/biostatistics). Each section will cover what the method is, when to use it, an example and some considerations. Let’s get started!</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Covariates vs Outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<p>This post focuses on imputation for covariates, rather than outcomes. The methods are the same, but the plausibility may be different for an outcome variable. Furthermore, it depends on the audience. For example, certain regulatory bodies may prefer several scenarios such as best-case and worst-case imputation.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
An Introduction to Methods for Missingness
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is meant to be an introduction to some of these methods. A few of them shouldn’t have much additional detail to learn about (i.e., complete cases) however others, such as multiple imputation, have a litany of information about them. For example, there are entire textbooks on multiple imputation.</p>
<p>The goal of this post is more to be an introduction to missingness, and help identify some potential scenarios to use the different methods while avoiding potential pitfalls.</p>
</div>
</div>
</section>
<section id="complete-cases-exclude-all-missing" class="level1">
<h1>Complete Cases (Exclude All Missing)</h1>
<section id="what-is-it" class="level2">
<h2 class="anchored" data-anchor-id="what-is-it">What is it?</h2>
<p>“Let’s just get rid of the missing data! Then our problem will be solved!”…not quite. While getting rid of the missing data certainly is <em>a</em> way to deal with missing values, you are also losing good information. However, like any method, there is a time and place for it.</p>
</section>
<section id="when-to-use" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use">When to Use</h2>
<p>Complete case analysis can be valid if we assume that the data are MAR <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. It also depends on how much missing data we have, and the corresponding reduction in sample size. If the missing data is small, for example less than 5%, this is a different situation than if there is 30% missingness.</p>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df.mar <span class="ot">&lt;-</span> <span class="fu">df_missing</span>(<span class="at">type =</span> <span class="st">"mar"</span>) <span class="co"># selecting mar data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">&lt;-</span> df.mar <span class="sc">|&gt;</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(df.mar<span class="sc">$</span>treasure_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2995.293</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(cc<span class="sc">$</span>treasure_value_mar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3017.684</code></pre>
</div>
</div>
</section>
<section id="considerations" class="level2">
<h2 class="anchored" data-anchor-id="considerations">Considerations</h2>
<p>Complete case analysis can be convenient from a data quality point of view, however it can cause some issues. By not imputing any values, we are only using the “observed” values. This might seem beneficial but it can cause problems. Firstly, the estimated statistics and regression coefficients may be biased unless the data is MAR <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. Secondly, there will be reduced precision (aka wider confidence intervals) because there is a reduction in sample size.</p>
<p>It’s also important to consider which patients are being removed and how many. Is this now the same target population that it was originally? Imagine if we ended up removing 25% of our sample! How would that affect our generalizability? This might change our target population.</p>
</section>
</section>
<section id="last-observation-carried-forward" class="level1">
<h1>Last Observation Carried Forward</h1>
<section id="what-is-it-1" class="level2">
<h2 class="anchored" data-anchor-id="what-is-it-1">What is it?</h2>
<p>Last observation carried forward (LOCF) is very much what it sounds like. We take the last value that was observed and use it.</p>
</section>
<section id="when-to-use-1" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-1">When to Use</h2>
<p>LOCF is used when there is longitudinal data, and it is assumed that it’s plausible. For example, if we need to carry through the value of sex (male/female). If there is missingness for this data but it is available at a previous encounter, then we can assume it’s the same.</p>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we need to have multiple measurements per pirate</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>n_pirates <span class="ot">&lt;-</span> <span class="dv">10</span>   <span class="co"># Number of unique pirates</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>n_measurements <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Number of measurements per pirate</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the data frame</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>df.locf <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pirate_id =</span> <span class="dv">1</span><span class="sc">:</span>n_pirates,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurement_id =</span> <span class="dv">1</span><span class="sc">:</span>n_measurements</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">treasure_value =</span> <span class="fu">runif</span>(<span class="at">n =</span> n_pirates <span class="sc">*</span> n_measurements, <span class="at">min =</span> <span class="dv">1000</span>, <span class="at">max =</span> <span class="dv">5000</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">haunted_island =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> n_pirates <span class="sc">*</span> n_measurements, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pirate_superstition =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> n_pirates <span class="sc">*</span> n_measurements, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>mcar_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df.locf), <span class="dv">15</span>) <span class="co"># randomly select 15 indices</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>df.locf<span class="sc">$</span>treasure_value_mcar <span class="ot">&lt;-</span> df.locf<span class="sc">$</span>treasure_value</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>df.locf<span class="sc">$</span>treasure_value_mcar[mcar_indices] <span class="ot">&lt;-</span> <span class="cn">NA</span> <span class="co"># set these values to</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># View the dataframe</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>df.locf <span class="sc">%&gt;%</span> <span class="fu">select</span>(pirate_id, measurement_id, treasure_value_mcar) <span class="sc">%&gt;%</span> </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(pirate_id, measurement_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   pirate_id measurement_id treasure_value_mcar
1          1              1                  NA
2          1              2            4811.364
3          1              3            4478.129
4          1              4            2864.015
5          1              5            4792.268
6          2              1                  NA
7          2              2                  NA
8          2              3            1243.352
9          2              4                  NA
10         2              5            1344.689
11         3              1            1716.238
12         3              2            3449.500
13         3              3            1939.598
14         3              4            1948.792
15         3              5                  NA
16         4              1            2356.886
17         4              2            2854.295
18         4              3            4972.062
19         4              4            1932.959
20         4              5            3889.595
21         5              1                  NA
22         5              2            2418.918
23         5              3            3712.791
24         5              4            1922.614
25         5              5            4688.018
26         6              1            2622.166
27         6              2            4529.692
28         6              3                  NA
29         6              4            1246.905
30         6              5            3455.364
31         7              1            3454.238
32         7              2                  NA
33         7              3            2509.240
34         7              4            2988.474
35         7              5            1643.866
36         8              1                  NA
37         8              2                  NA
38         8              3            2844.736
39         8              4                  NA
40         8              5            1731.763
41         9              1            4294.102
42         9              2                  NA
43         9              3                  NA
44         9              4            4032.742
45         9              5            3920.734
46        10              1            2495.928
47        10              2            1860.267
48        10              3                  NA
49        10              4                  NA
50        10              5            3358.103</code></pre>
</div>
</div>
</section>
<section id="considerations-1" class="level2">
<h2 class="anchored" data-anchor-id="considerations-1">Considerations</h2>
<p>The plausibility of LOCF needs to be considered. For example, if we are studying monsters and human, we can safely assume that the monster will still be a monster. Would this be true for the number of planets that a monster has been too? What about a lab value? Is a lab value stable at 30 days? What about 60, 90 or 400? This becomes a balance between what’s clinical plausible and the reduction in sample size (if a shorter time window, might be more plausible but the last value might be further away than that).</p>
</section>
</section>
<section id="mean-value-imputation" class="level1">
<h1>Mean Value Imputation</h1>
<section id="what-is-it-2" class="level2">
<h2 class="anchored" data-anchor-id="what-is-it-2">What is it?</h2>
<p>Mean value imputation takes the mean of the values that we <em>do</em> have and uses this wherever there are missing values. As a side note, the mean is sometimes called the expected value in statistics.</p>
</section>
<section id="when-to-use-2" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-2">When to Use</h2>
<p>You probably guessed this already, but we can use it when we have a mean! So this can be used for any variable that has a mean (typically a continuous variable). If the data are MCAR then the effect should be unbiased <span class="citation" data-cites="dziura2013">(<a href="#ref-dziura2013" role="doc-biblioref">Dziura et al. 2013</a>)</span>.</p>
</section>
<section id="example-2" class="level2">
<h2 class="anchored" data-anchor-id="example-2">Example</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df.mcar <span class="ot">&lt;-</span> <span class="fu">df_missing</span>(<span class="at">type =</span> <span class="st">"mcar"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df.mean.imputation <span class="ot">&lt;-</span> df.mcar <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_treasure_value =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(treasure_value_mcar) <span class="sc">~</span> <span class="fu">mean</span>(df.mcar<span class="sc">$</span>treasure_value_mcar, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(treasure_value_mcar) <span class="sc">~</span> treasure_value_mcar</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="considerations-2" class="level2">
<h2 class="anchored" data-anchor-id="considerations-2">Considerations</h2>
<p>This method is easy to implement and quick but there are some things we need to consider. First, the effect should be unbiased however the standard errors aren’t necessarily. This is due to this method artificially reducing the variation in the data set <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. It also ignores relationships with other variables which be might be true, but the plausibility of this needs to be considered <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. These imputed values end up being treated as equal to the values that aren’t missing <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>, which may be incorrect since we know the observed values were recorded and not imputed.</p>
</section>
</section>
<section id="condition-mean-imputation-aka-using-regression" class="level1">
<h1>Condition mean Imputation (aka using Regression)</h1>
<section id="what-is-it-3" class="level2">
<h2 class="anchored" data-anchor-id="what-is-it-3">What is it?</h2>
<p>Conditional mean imputation is very similar to mean imputation but instead of using the mean, we’ll use the conditional mean. How do we know the conditional mean? By predicting the result based on a model that we’ve fit to the data that we <em>do</em> have.</p>
</section>
<section id="when-to-use-3" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-3">When to Use</h2>
<p>We can use this in similar scenarios to the mean value imputation. When the data is MCAR or MAR the effects are expected to be unbiased <span class="citation" data-cites="dziura2013">(<a href="#ref-dziura2013" role="doc-biblioref">Dziura et al. 2013</a>)</span>. This method can incorporate relationships with other variables, which is an advantage over mean value imputation.</p>
</section>
<section id="example-3" class="level2">
<h2 class="anchored" data-anchor-id="example-3">Example</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df.mar <span class="ot">&lt;-</span> <span class="fu">df_missing</span>(<span class="at">type =</span> <span class="st">"mar"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>mar.regress <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  treasure_value_mar <span class="sc">~</span> haunted_island <span class="sc">+</span> pirate_superstition, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df.mar</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>treasure_value_imputed <span class="ot">=</span> <span class="fu">predict</span>(mar.regress)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>regress.imputed <span class="ot">&lt;-</span> df.mar <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">treasure_value_imputed =</span> <span class="fu">case_when</span>(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(treasure_value_mar) <span class="sc">~</span> <span class="fu">predict</span>(mar.regress, <span class="at">newdata =</span> df.mar, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> treasure_value_mar</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(regress.imputed<span class="sc">$</span>treasure_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2995.293</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>var.og <span class="ot">=</span> <span class="fu">sd</span>(regress.imputed<span class="sc">$</span>treasure_value)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(regress.imputed<span class="sc">$</span>treasure_value_imputed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3046.162</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>var.imputed <span class="ot">=</span> <span class="fu">sd</span>(regress.imputed<span class="sc">$</span>treasure_value_imputed)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(regress.imputed<span class="sc">$</span>treasure_value_mar, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3017.684</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(regress.imputed<span class="sc">$</span>treasure_value_mar, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1111.26</code></pre>
</div>
</div>
</section>
<section id="considerations-3" class="level2">
<h2 class="anchored" data-anchor-id="considerations-3">Considerations</h2>
<p>This method can artificially amplify the multivariate relationship in the data <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. For example, if we assume that age is related to our covariate then we end up imputing based on the values of age (which may not be the case). These imputed values end up being treated as equal to the values that aren’t missing <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>, which may be incorrect since we know the observed values were recorded and not imputed.</p>
</section>
</section>
<section id="multiple-imputation" class="level1">
<h1>Multiple Imputation</h1>
<section id="what-is-it-4" class="level2">
<h2 class="anchored" data-anchor-id="what-is-it-4">What is it?</h2>
<p>Multiple imputation (MI) imputes a value for each missing value. It picks a value from a list of options, aka the distribution, and imputes it. This creates one data set. This is then done again, and again until there are multiple complete datasets where the missing value has been filled in using plausible values <span class="citation" data-cites="austin2021missing">(<a href="#ref-austin2021missing" role="doc-biblioref">Austin et al. 2021</a>)</span>. Each of these data sets is used to conduct the analysis, for example fitting a generalized linear model, then the results are pooled. For our case, we’ll focus on the method known as multivariate imputation by chained equations (MICE). For more detail about it, I highly recommend <span class="citation" data-cites="austin2021missing">Austin et al. (<a href="#ref-austin2021missing" role="doc-biblioref">2021</a>)</span>.</p>
</section>
<section id="when-to-use-4" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-4">When to Use</h2>
<p>MI, based on <span class="citation" data-cites="austin2021missing">Austin et al. (<a href="#ref-austin2021missing" role="doc-biblioref">2021</a>)</span>, can be used when the data are assumed to be MCAR or MAR. The methods can be modified if the data is thought to be MNAR <span class="citation" data-cites="van2018flexible">(<a href="#ref-van2018flexible" role="doc-biblioref">Van Buuren 2018</a>)</span>. This method can be used when it’s assumed that all the plausible values have been captured for the variable of interest.</p>
</section>
<section id="example-4" class="level2">
<h2 class="anchored" data-anchor-id="example-4">Example</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice) <span class="co"># package used for multiple imputation using chained equations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'mice'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    filter</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    cbind, rbind</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df.mcar <span class="ot">&lt;-</span> <span class="fu">df_missing</span>(<span class="at">type =</span> <span class="st">"mcar"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Performing the imputation</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>mice_mod <span class="ot">&lt;-</span> <span class="fu">mice</span>(df.mcar, <span class="at">m=</span><span class="dv">5</span>, <span class="at">maxit=</span><span class="dv">50</span>, <span class="at">meth=</span><span class="st">'pmm'</span>, <span class="at">seed=</span><span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 iter imp variable
  1   1
  1   2
  1   3
  1   4
  1   5
  2   1
  2   2
  2   3
  2   4
  2   5
  3   1
  3   2
  3   3
  3   4
  3   5
  4   1
  4   2
  4   3
  4   4
  4   5
  5   1
  5   2
  5   3
  5   4
  5   5
  6   1
  6   2
  6   3
  6   4
  6   5
  7   1
  7   2
  7   3
  7   4
  7   5
  8   1
  8   2
  8   3
  8   4
  8   5
  9   1
  9   2
  9   3
  9   4
  9   5
  10   1
  10   2
  10   3
  10   4
  10   5
  11   1
  11   2
  11   3
  11   4
  11   5
  12   1
  12   2
  12   3
  12   4
  12   5
  13   1
  13   2
  13   3
  13   4
  13   5
  14   1
  14   2
  14   3
  14   4
  14   5
  15   1
  15   2
  15   3
  15   4
  15   5
  16   1
  16   2
  16   3
  16   4
  16   5
  17   1
  17   2
  17   3
  17   4
  17   5
  18   1
  18   2
  18   3
  18   4
  18   5
  19   1
  19   2
  19   3
  19   4
  19   5
  20   1
  20   2
  20   3
  20   4
  20   5
  21   1
  21   2
  21   3
  21   4
  21   5
  22   1
  22   2
  22   3
  22   4
  22   5
  23   1
  23   2
  23   3
  23   4
  23   5
  24   1
  24   2
  24   3
  24   4
  24   5
  25   1
  25   2
  25   3
  25   4
  25   5
  26   1
  26   2
  26   3
  26   4
  26   5
  27   1
  27   2
  27   3
  27   4
  27   5
  28   1
  28   2
  28   3
  28   4
  28   5
  29   1
  29   2
  29   3
  29   4
  29   5
  30   1
  30   2
  30   3
  30   4
  30   5
  31   1
  31   2
  31   3
  31   4
  31   5
  32   1
  32   2
  32   3
  32   4
  32   5
  33   1
  33   2
  33   3
  33   4
  33   5
  34   1
  34   2
  34   3
  34   4
  34   5
  35   1
  35   2
  35   3
  35   4
  35   5
  36   1
  36   2
  36   3
  36   4
  36   5
  37   1
  37   2
  37   3
  37   4
  37   5
  38   1
  38   2
  38   3
  38   4
  38   5
  39   1
  39   2
  39   3
  39   4
  39   5
  40   1
  40   2
  40   3
  40   4
  40   5
  41   1
  41   2
  41   3
  41   4
  41   5
  42   1
  42   2
  42   3
  42   4
  42   5
  43   1
  43   2
  43   3
  43   4
  43   5
  44   1
  44   2
  44   3
  44   4
  44   5
  45   1
  45   2
  45   3
  45   4
  45   5
  46   1
  46   2
  46   3
  46   4
  46   5
  47   1
  47   2
  47   3
  47   4
  47   5
  48   1
  48   2
  48   3
  48   4
  48   5
  49   1
  49   2
  49   3
  49   4
  49   5
  50   1
  50   2
  50   3
  50   4
  50   5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Number of logged events: 1</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a GLM to each imputed dataset. For this case, imagine that haunted_island </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># is the outcome </span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>glm_models <span class="ot">&lt;-</span> <span class="fu">with</span>(mice_mod, <span class="fu">glm</span>(haunted_island <span class="sc">~</span> treasure_value_mcar <span class="sc">+</span> pirate_superstition, <span class="at">family =</span> <span class="fu">binomial</span>()))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Pooling the results together </span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>pooled_results <span class="ot">&lt;-</span> <span class="fu">pool</span>(glm_models)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the pooled results</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(pooled_results) <span class="sc">|&gt;</span> </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate, std.error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                 term      estimate   std.error
1         (Intercept)  1.283701e-01 0.370735275
2 treasure_value_mcar -3.340088e-05 0.000110922
3 pirate_superstition -1.764281e-01 0.242919776</code></pre>
</div>
</div>
</section>
<section id="considerations-4" class="level2">
<h2 class="anchored" data-anchor-id="considerations-4">Considerations</h2>
<p>There are some considerations for using this. We need to decide if we think all the plausible values have been captured. MI only pulls from the existing values. So for example, if we have red, blue, yellow and green marbles in our population but only blue and green in our sample then red and yellow won’t be imputed.</p>
<p>We also need to decide how large the number of imputed data sets are. There are many different ways to ascertain this. <span class="citation" data-cites="white2011multiple">White, Royston, and Wood (<a href="#ref-white2011multiple" role="doc-biblioref">2011</a>)</span> suggested that as a rule of thumb it should be at least as large as the percentage of subjects with missing data. So if missingness is 22%, then we need at least 22 data sets.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MI is broad, this is an introduction
</div>
</div>
<div class="callout-body-container callout-body">
<p>Multiple imputation is one of those methods that has an extensive amount of literature on it. This was meant to be an introduction but there are full textbooks that focus on the topic.</p>
</div>
</div>
</section>
</section>
<section id="summary-of-methods" class="level1">
<h1>Summary of Methods</h1>
<p>These are a few of the missing data methods that you may come across, however there is a VAST number of methods for missing data. The key takeaway should be to consider these, regardless of the method:</p>
<ul>
<li><p>What kind of assumptions are required? (i.e., MCAR, MNAR, MAR)</p></li>
<li><p>What are the tradeoffs? For example, increase in data quality but decreased in precision and generalizibility? Or increase in precision but decrease in replicability?</p></li>
<li><p>Practically speaking: is this the right use case for the audience? For example, a regulatory body may have different wants than an eighth grader wanting her help with analyzing her missing pets data.</p></li>
</ul>
<p>This was just an introduction but there are a ton of great resources on each of these methods! There are also a bunch of other methods that are great to learn too (I’m currently still learning some of them so perhaps it will be a source of future posts!). This includes: K-Nearest Neighbour Matching, Predictive Mean Matching, Random Forest imputation and much more!</p>
<p>Hopefully this blog post was useful as an introduction to five methods to start, but this is only the beginning! Happy missing data exploring!</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-austin2021missing" class="csl-entry" role="listitem">
Austin, Peter C, Ian R White, Douglas S Lee, and Stef van Buuren. 2021. <span>“Missing Data in Clinical Research: A Tutorial on Multiple Imputation.”</span> <em>Canadian Journal of Cardiology</em> 37 (9): 1322–31.
</div>
<div id="ref-dziura2013" class="csl-entry" role="listitem">
Dziura, James D, Lori A Post, Qing Zhao, Zhixuan Fu, and Peter Peduzzi. 2013. <span>“Strategies for Dealing with Missing Data in Clinical Trials: From Design to Analysis.”</span> <em>The Yale Journal of Biology and Medicine</em> 86 (3): 343.
</div>
<div id="ref-van2018flexible" class="csl-entry" role="listitem">
Van Buuren, Stef. 2018. <em>Flexible Imputation of Missing Data</em>. CRC press.
</div>
<div id="ref-white2011multiple" class="csl-entry" role="listitem">
White, Ian R, Patrick Royston, and Angela M Wood. 2011. <span>“Multiple Imputation Using Chained Equations: Issues and Guidance for Practice.”</span> <em>Statistics in Medicine</em> 30 (4): 377–99.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>